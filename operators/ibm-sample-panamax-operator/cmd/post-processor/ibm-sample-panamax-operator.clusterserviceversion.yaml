apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  annotations:
    alm-examples: '[{"apiVersion":"sample.ibm.com/v1beta1","kind":"Panamax","metadata":{"labels":{"app.kubernetes.io/instance":"sample-panamax","app.kubernetes.io/managed-by":"panamax-operator","app.kubernetes.io/name":"panamax-operator"},"name":"sample-panamax"},"spec":{"license":{"accept":true},"systemStatus":"betterThanYesterday","version":"v1.0.0"},"status":{}},{"apiVersion":"sample.ibm.com/v1beta1","kind":"PanamaxConfigJoe","metadata":{"name":"sample-config-panamax"},"spec":{"supportedOperandChannels":["channel-1.1","channel-1.3"],"supportedOperandVersions":["v1.0.0","v1.0.1","v1.0.2","v2.0"]},"status":{}}]'
    capabilities: Basic Install
    operators.operatorframework.io/builder: operator-sdk-v1.1.0
    operators.operatorframework.io/internal-objects: '["panamaxconfigs.sample.ibm.com"]'
    operators.operatorframework.io/project_layout: go.kubebuilder.io/v2
  creationTimestamp: null
  labels:
    app.kubernetes.io/instance: sample-panamax-operator
    app.kubernetes.io/managed-by: panamax-operator
    app.kubernetes.io/name: panamax-operator
  name: ibm-sample-panamax-operator.v4.1.0
  namespace: placeholder
spec:
  apiservicedefinitions: {}
  customresourcedefinitions:
    owned:
    - description: PanamaxConfig is the Schema for the panamaxconfigs API
      displayName: Panamax Custom Implementation
      kind: PanamaxConfig
      name: panamaxconfigs.sample.ibm.com
      resources:
      - kind: PanamaxConfigs
        name: ""
        version: v1beta1
      specDescriptors:
      - displayName: Supported Operand Channels
        path: supportedOperandChannels
      - displayName: Supported Operand Versions
        path: supportedOperandVersions
      statusDescriptors:
      - displayName: Last Update
        path: lastUpdate
      version: v1beta1
    - description: Panamax is the Schema for the nginxes API
      displayName: Panamax Custom Implementation
      kind: Panamax
      name: panamaxes.sample.ibm.com
      resources:
      - kind: ConfigMaps
        name: ""
        version: v1
      - kind: Deployments
        name: ""
        version: v1
      - kind: Panamaxes
        name: ""
        version: v1beta1
      - kind: Pods
        name: ""
        version: v1
      - kind: Replicasets
        name: ""
        version: v1
      - kind: Route
        name: ""
        version: v1
      - kind: Services
        name: ""
        version: v1
      specDescriptors:
      - displayName: Operand License Structure
        path: license
        x-descriptors:
        - urn:alm:descriptor:com.tectonic.ui:text
      - displayName: Accept Operand License
        path: license.accept
        x-descriptors:
        - urn:alm:descriptor:com.tectonic.ui:booleanSwitch
      - displayName: Key From
        path: license.keyFrom
      - displayName: Secret Key Ref
        path: license.keyFrom.secretKeyRef
      - displayName: Operand License Key
        path: license.keyFrom.secretKeyRef.name
        x-descriptors:
        - urn:alm:descriptor:io.kubernetes:Secret
      - displayName: License
        path: license.license
      - displayName: Measure
        path: license.measure
      - displayName: Use
        path: license.use
      - displayName: Operand Running Status
        path: systemStatus
        x-descriptors:
        - urn:alm:descriptor:com.tectonic.ui:text
      - displayName: Operand Version
        path: version
        x-descriptors:
        - urn:alm:descriptor:com.tectonic.ui:text
      statusDescriptors:
      - displayName: Conditions
        path: conditions
      - displayName: Message
        path: conditions[0].message
      - displayName: Reason
        path: conditions[0].reason
      - displayName: Status
        path: conditions[0].status
      - displayName: Type
        path: conditions[0].type
      - displayName: Name
        path: name
      - displayName: Version
        path: versions
      - displayName: Available
        path: versions.available
      - displayName: Channels
        path: versions.available.channels
      - displayName: Name
        path: versions.available.channels[0].name
      - displayName: Versions
        path: versions.available.versions
      - displayName: Name
        path: versions.available.versions[0].name
      - displayName: Reconciled
        path: versions.reconciled
      version: v1beta1
    required:
    - description: CouchDBCluster desc via dep
      displayName: CouchDBCluster displayName via dep
      kind: CouchDBCluster
      name: couchdbclusters.couchdb.databases.cloud.ibm.com
      version: v1
  description: |
    The IBM Panamax Operator is a reference implementation operator developed by the IBM Cloud Pak Engineering squad.  For more information visit the [Github Repository](https://github.ibm.com/CloudPakOpenContent/ibm-sample-panamax-operator).
    # Name
    IBM&reg; Panamax Operator
    # Introduction
    ## Details
    The IBM&reg; Panamax Operator is the reference implementation operator produced by the Cloud Pak Engineering team.  This operator is meant to be used as a best practices and standards implementation, and will provide guidance to teams looking to design and create an operator for their offering.
    For more information and guidance refer to the following:
    * [Playbook](https://playbook.cloudpaklab.ibm.com/)
    * cloudpak-certify channel on slack
    ## Features
    *  **Panamax Operator**
      Panamax Operator is a reference implementation operator, that wraps and ngxinx operator.
    # Details
    ## Prerequisites
    An `ImageContentSourcePolicy` resource must be deployed to the cluster to mirror the images in the operator manifests to the correct location.
    ```yaml
    apiVersion: operator.openshift.io/v1alpha1
    kind: ImageContentSourcePolicy
    metadata:
      name: mirror-config
    spec:
      repositoryDigestMirrors:
      - mirrors:
        - cp.stg.icr.io/cp
        source: cp.icr.io/cp
      - mirrors:
        - cp.stg.icr.io/cp
        source: icr.io/cpopen
    ```
    Non-OLM installs:
    To install the operator through a mechanism other than OLM, the ServiceAccount that deploys the operator deployment must have RBAC access to create ClusterRole resources.
    ### Resources Required
    * Describe Minimum System Resources Required
    Minimum scheduling capacity:
    | Software  | Memory (GB) | CPU (cores) | Disk (GB) | Nodes |
    | --------- | ----------- | ----------- | --------- | ----- |
    |           |             |             |           |       |
    | **Total** |             |             |           |       |
    # Installing
    * Include installation instructions or links to documentation
    * Include the basic things necessary to install the product
    * Include environment setup or any other items required
    ## Configuration
    * Provide configuration instructions if any
    ## Storage
    * Define how storage works with the workload
    * Dynamic vs PV pre-created
    * Considerations if using hostpath, local volume, empty dir
    * Loss of data considerations
    * Any special quality of service or security needs for storage
    ## SecurityContextConstraints Requirements
    ### Panamax Controller
    The Sample Panamax Operator controller currently runs with the default Red Hat `restricted` SCC.
    This Operator also defines a custom SecurityContextConstraints object which is used to finely control the permissions/capabilities needed to deploy this Operator, the definition of this SCC is shown below:
    ```yaml
    apiVersion: security.openshift.io/v1
    kind: SecurityContextConstraints
    metadata:
      name: panamaxSCC
    allowHostPorts: false
    priority: null
    requiredDropCapabilities:
      - MKNOD
    allowPrivilegedContainer: false
    runAsUser:
      type: MustRunAsRange
    users: []
    allowHostDirVolumePlugin: false
    allowHostIPC: false
    seLinuxContext:
      type: MustRunAs
    readOnlyRootFilesystem: false
    fsGroup:
      type: MustRunAs
    groups: []
    defaultAddCapabilities: null
    supplementalGroups:
      type: RunAsAny
    volumes:
      - configMap
      - downwardAPI
      - emptyDir
      - persistentVolumeClaim
      - projected
      - secret
    allowHostPID: false
    allowHostNetwork: false
    allowPrivilegeEscalation: true
    allowedCapabilities: null
    ```
    If you wish to deploy the Operator controller under the custom SCC enforcement, then the SCC must be bound to the namespace before installing the Operator.  
    ```
    $ oc login # login as cluster admin 
    $ oc apply -f <save the custom scc definition as a file on disk>
    $ oc create clusterrole panamax-scc-binding-cluster-role --verb="use" --resource="securityContextConstraints" --resource-name="panamaxSCC"
    $ oc create rolebinding panamax-scc-binding-namespace-role-binding --clusterrole="panamax-scc-binding-cluster-role" --group="system:serviceaccounts:<namespace for panamax deployment>" 
    ```
    For more information about the OpenShift Container Platform Security Context Constraints, see [Managing Security Context Constraints](https://docs.openshift.com/container-platform/4.3/authentication/managing-security-context-constraints.html).
    ### Panamax Operand Application
    The Sample Panamax Operator controller currently runs with the Red Hat Platform `anyuid` SCC.
    This Operand also defines a custom SecurityContextConstraints object which is used to finely control the permissions/capabilities needed to deploy this Application, the definition of this SCC is shown below:
    ```yaml
    apiVersion: security.openshift.io/v1
    kind: SecurityContextConstraints
    metadata:
      name: panamax-operand-scc
    allowHostDirVolumePlugin: false
    allowHostIPC: false
    allowHostNetwork: false
    allowHostPID: false
    allowHostPorts: false
    allowPrivilegeEscalation: true
    allowPrivilegedContainer: false
    allowedCapabilities:
    - "SETPCAP"
    -	"AUDIT_WRITE"
    -	"CHOWN"
    -	"NET_RAW"
    -	"DAC_OVERRIDE"
    -	"FOWNER"
    -	"FSETID"
    -	"KILL"
    -	"SETUID"
    -	"SETGID"
    -	"NET_BIND_SERVICE"
    -	"SYS_CHROOT"
    -	"SETFCAP"
    allowedUnsafeSysctls: null
    defaultAddCapabilities: null
    fsGroup:
      type: RunAsAny
    groups: []
    priority: null
    readOnlyRootFilesystem: false
    requiredDropCapabilities: 
    - MKNOD
    runAsUser:
      type: RunAsAny
    seLinuxContext:
      type: RunAsAny
    seccompProfiles:
    - '*'
    supplementalGroups:
      type: RunAsAny
    users: []
    volumes:
    - configMap
    - downwardAPI
    - emptyDir
    - persistentVolumeClaim
    - projected
    - secret
    ```
    If you wish to deploy the Operand under the custom SCC enforcement, then the SCC must be bound to the namespace before applying the CR for Panamax.  
    ```
    $ oc login # login as cluster admin 
    $ oc apply -f <save the custom scc definition as a file on disk>
    $ oc create clusterrole panamax-operand-scc-binding-cluster-role --verb="use" --resource="securityContextConstraints" --resource-name="panamaxSCC"
    $ oc create rolebinding panamax-operand-scc-binding-namespace-role-binding --clusterrole="panamax-operand-scc-binding-cluster-role" --group="system:serviceaccounts:<namespace for panamax deployment>" 
    ```
    For more information about the OpenShift Container Platform Security Context Constraints, see [Managing Security Context Constraints](https://docs.openshift.com/container-platform/4.3/authentication/managing-security-context-constraints.html).
    ## Limitations
    * Deployment limits - can you deploy more than once, can you deploy into different namespace
    * List specific limitations such as platforms, security, replica's, scaling, upgrades etc.. - noteworthy limits identified
    * List deployment limitations such as : restrictions on deploying more than once or into custom namespaces.
    * Not intended to provide chart nuances, but more a state of what is supported and not - key items in simple bullet form.
    * Does it work on ROKS? Openshift Container Platform?
    ## Documentation
    * Can have as many supporting links as necessary for this specific workload however don't overload the consumer with unnecessary information.
    * Can be links to special procedures in the knowledge center.
  displayName: Panamax Reference Sample
  icon:
  - base64data: ""
    mediatype: ""
  install:
    spec:
      clusterPermissions:
      - rules:
        - apiGroups:
          - rbac.authorization.k8s.io
          resources:
          - clusterrolebindings
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - rbac.authorization.k8s.io
          resources:
          - clusterroles
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        serviceAccountName: ibm-sample-panamax-operator-ibm-sample-panamax-operator
      deployments:
      - name: ibm-sample-panamax-operator-controller-manager
        spec:
          replicas: 1
          selector:
            matchLabels:
              app.kubernetes.io/instance: sample-panamax-operator
              app.kubernetes.io/managed-by: panamax-operator
              app.kubernetes.io/name: panamax-operator
              control-plane: controller-manager
          strategy: {}
          template:
            metadata:
              annotations:
                productID: bf6f9ad69412c4a0cba6b35cade684dc
                productMetric: FREE
                productName: Panamax Reference Operator
                productVersion: 0.0.2
              creationTimestamp: null
              labels:
                app.kubernetes.io/instance: sample-panamax-operator
                app.kubernetes.io/managed-by: panamax-operator
                app.kubernetes.io/name: panamax-operator
                control-plane: controller-manager
            spec:
              affinity:
                nodeAffinity:
                  preferredDuringSchedulingIgnoredDuringExecution:
                  - preference:
                      matchExpressions:
                      - key: beta.kubernetes.io/arch
                        operator: In
                        values:
                        - amd64
                    weight: 3
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                    - matchExpressions:
                      - key: beta.kubernetes.io/arch
                        operator: In
                        values:
                        - amd64
              containers:
              - args:
                - --enable-leader-election
                command:
                - /manager
                env:
                - name: WATCH_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['olm.targetNamespaces']
                - name: MY_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                - name: WEBHOOK_ENABLED
                  value: "true"
                - name: OLM_DEPLOY
                  value: "true"
                - name: RELATED_IMAGE_PANAMAX
                  value: cp.icr.io/cp/ibm-panamax-nginx@sha256:8223ffae31b299220a3f7ff21c7afde6478cdfb0bf4d1886525a4e1105341741
                image: icr.io/cpopen/ibm-sample-panamax-operator@sha256:e88648efffa1ed5e7c4873bf925d25023c926e77ae9dd5152fcbb2c8d00399bd
                imagePullPolicy: Always
                name: manager
                ports:
                - containerPort: 9443
                  name: webhook-server
                  protocol: TCP
                resources:
                  limits:
                    cpu: 100m
                    memory: 30Mi
                  requests:
                    cpu: 100m
                    memory: 20Mi
                securityContext:
                  allowPrivilegeEscalation: true
                  capabilities:
                    drop:
                    - ALL
                  privileged: false
                  readOnlyRootFilesystem: false
              serviceAccount: ibm-sample-panamax-operator
              serviceAccountName: ibm-sample-panamax-operator-ibm-sample-panamax-operator
              terminationGracePeriodSeconds: 10
      permissions:
      - rules:
        - apiGroups:
          - ""
          resources:
          - configmaps
          verbs:
          - get
          - list
          - watch
          - create
          - update
          - patch
          - delete
        - apiGroups:
          - ""
          resources:
          - configmaps/status
          verbs:
          - get
          - update
          - patch
        - apiGroups:
          - ""
          resources:
          - events
          verbs:
          - create
          - patch
        - apiGroups:
          - ""
          resources:
          - configmaps
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - endpoints
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - events
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - persistentvolumeclaims
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - pods
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - secrets
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - serviceaccounts
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - services
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - ""
          resources:
          - services/finalizers
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - apps
          resources:
          - deployments
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - apps
          resources:
          - deployments/finalizers
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - apps
          resources:
          - replicasets
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - monitoring.coreos.com
          resources:
          - servicemonitors
          verbs:
          - create
          - get
        - apiGroups:
          - operator.ibm.com
          resources:
          - operandrequests
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - rbac.authorization.k8s.io
          resources:
          - rolebindings
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - route.openshift.io
          resources:
          - routes
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxconfigs
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxconfigs/finalizers
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxconfigs/status
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxes
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxes/finalizers
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups:
          - sample.ibm.com
          resources:
          - panamaxes/status
          verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
        serviceAccountName: ibm-sample-panamax-operator-ibm-sample-panamax-operator
    strategy: deployment
  installModes:
  - supported: true
    type: OwnNamespace
  - supported: false
    type: SingleNamespace
  - supported: false
    type: MultiNamespace
  - supported: false
    type: AllNamespaces
  keywords:
  - sample
  links:
  - name: Ibm Sample Panamax Operator
    url: https://ibm-sample-panamax-operator.domain
  maturity: alpha
  provider:
    name: content team
  relatedImages:
  - image: cp.icr.io/cp/ibm-panamax-nginx@sha256:de4bf2ffa71e255bfd4ec9a237f6c95cd894fa82d315840dca65d98a6de9cd30
    name: RELATED_IMAGE_PANAMAX
    tag: v3.0.13
  replaces: ""
  version: 4.1.0
  webhookdefinitions:
  - admissionReviewVersions:
    - v1beta1
    containerPort: 9443
    deploymentName: ibm-sample-panamax-operator-controller-manager
    failurePolicy: Fail
    generateName: vpanamax.kb.io
    rules:
    - apiGroups:
      - sample.ibm.com
      apiVersions:
      - v1beta1
      operations:
      - CREATE
      - UPDATE
      resources:
      - panamaxes
    sideEffects: None
    targetPort: 9443
    type: ValidatingAdmissionWebhook
    webhookPath: /validate-sample-ibm-com-v1beta1-panamax
  - admissionReviewVersions:
    - v1beta1
    containerPort: 9443
    deploymentName: ibm-sample-panamax-operator-controller-manager
    failurePolicy: Fail
    generateName: mpanamax.kb.io
    rules:
    - apiGroups:
      - sample.ibm.com
      apiVersions:
      - v1beta1
      operations:
      - CREATE
      - UPDATE
      resources:
      - panamaxes
    sideEffects: None
    targetPort: 9443
    type: MutatingAdmissionWebhook
    webhookPath: /mutate-sample-ibm-com-v1beta1-panamax
